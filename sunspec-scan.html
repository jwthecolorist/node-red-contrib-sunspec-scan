<script type="text/javascript">
    RED.nodes.registerType('sunspec-scan', {
        category: 'function',
        color: '#f3b567',
        defaults: {
            name: { value: "" },
            ip: { value: "", required: false },
            port: { value: "502", required: true, validate: RED.validators.number() },
            timeout: { value: "2000", required: true, validate: RED.validators.number() },
            pacing: { value: "2", validate: RED.validators.regex(/^[0-9.]*$/) }, // New Pacing Field (Default 2s)
            unitId: { value: "", required: false },
            scanIds: { value: true },

            readMode: { value: "scan" }, // 'scan', 'parameter', 'list'

            // Single Parameter Mode
            selectedDevice: { value: "" },
            selectedDeviceLabel: { value: "" }, // Persist Label
            selectedModel: { value: "" },
            selectedModelLabel: { value: "" }, // Persist Label
            selectedPoint: { value: "" },
            selectedPointLabel: { value: "" }, // Persist Label
            selectedId: { value: "" },

            // Custom List Mode
            outputList: { value: [] },

            // Output Formatting
            roundDecimals: { value: true }
        },
        inputs: 1,
        outputs: 1,
        icon: "bridge.svg",
        label: function () {
            if (this.readMode === 'parameter') {
                return this.name || `Read ${this.selectedPoint || "SunSpec"}`;
            }
            if (this.readMode === 'list') {
                return this.name || `Read List (${this.outputList ? this.outputList.length : 0})`;
            }
            return this.name || "SunSpec Scan";
        },
        oneditprepare: function () {
            const node = this;
            let currentNetworkMap = {};

            let savedDevices = [];

            // Fetch Server Network Map immediately
            $.getJSON('sunspec-scan/network', function (map) {
                if (map) currentNetworkMap = map;
                // Fetch Saved Devices
                $.getJSON('sunspec-scan/devices', function (devs) {
                    savedDevices = devs || [];
                    populateDeviceSelect();
                });
            });

            // Tabs Logic
            const tabs = RED.tabs.create({
                id: "node-input-sunspec-tabs",
                onchange: function (tab) {
                    $("#node-input-tabs-content").children().hide();
                    $("#" + tab.id).show();
                }
            });
            tabs.addTab({
                id: "sunspec-tab-scanner",
                label: "Scanner"
            });
            tabs.addTab({
                id: "sunspec-tab-settings",
                label: "Settings"
            });

            // Mode Select Handler
            $("#node-input-readMode").on("change", function () {
                const mode = $(this).val();
                $(".mode-group").hide();

                if (mode === "scan") $(".scan-mode-only").show();
                else if (mode === "parameter") $(".param-mode-only").show();
                else if (mode === "list") $(".list-mode-only").show();
            });

            // Auto-toggle Scan All based on Unit ID input
            // Deprecated: Logic now handled by parsing Unit ID string directly
            /*
            $("#node-input-unitId").on("input", function() {
                if ($(this).val().trim() !== "") {
                    $("#node-input-scanIds").prop("checked", false);
                } else {
                    $("#node-input-scanIds").prop("checked", true);
                }
            });
            */

            // TABS LOGIC

            // SCAN NETWORK BUTTON
            $("#btn-scan-network").click(function () {
                const $btn = $(this);
                const $stopBtn = $("#btn-stop-scan");
                const $prog = $("#scan-progress-bar");

                let ip = $("#node-input-ip").val();
                // Validate port and timeout with sensible defaults
                let port = parseInt($("#node-input-port").val()) || 502;
                let timeout = parseInt($("#node-input-timeout").val()) || 2000;
                const unitId = $("#node-input-unitId").val();

                // Validate range constraints
                if (port < 1 || port > 65535) port = 502;
                if (timeout < 100 || timeout > 30000) timeout = 2000;

                // Default to All Local if empty
                if (!ip) ip = "0.0.0.0/0";

                $prog.show();
                $btn.hide();
                $stopBtn.show();
                $("#scan-status-text").text("Starting scan...");

                // Polling for Status
                const statusInterval = setInterval(function () {
                    $.getJSON("sunspec-scan/status", function (data) {
                        if (data.status) $("#scan-status-text").text(data.status);
                    });
                }, 500);



                const currentScanRequest = $.ajax({
                    url: "sunspec-scan/discover",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        ip: ip,
                        port: port,
                        unitId: unitId,
                        timeout: timeout
                    }),
                    success: function (results) {
                        clearInterval(statusInterval);
                        $btn.html('<i class="fa fa-search"></i> Scan').prop("disabled", false).show();
                        $stopBtn.hide();
                        $prog.hide();
                        // Refresh Saved Devices list (as auto-save may have occurred)
                        $.getJSON('sunspec-scan/devices', function (devs) {
                            if (devs) savedDevices = devs;
                            populateDeviceSelect(results);
                            RED.notify("Network scan complete. Found " + Object.keys(results).length + " devices.", "success");
                        });
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        clearInterval(statusInterval);
                        $btn.html('<i class="fa fa-search"></i> Scan').prop("disabled", false).show();
                        $stopBtn.hide();
                        $prog.hide();
                        if (textStatus !== 'abort') {
                            RED.notify("Scan status: " + textStatus, "warning");
                        } else {
                            RED.notify("Scan stopped by user.", "info");
                        }
                    }
                });

                // STOP SCAN BUTTON
                // Unbind previous click to prevent multiple handlers if reopened? No, OnEditPrepare creates fresh DOM.
                $("#btn-stop-scan").off('click').click(function () {
                    $.post("sunspec-scan/stop", function () {
                        // RED.notify("Stopping scan...", "info"); // XHR abort will trigger "stopped by user"
                    });
                    if (currentScanRequest) {
                        currentScanRequest.abort();
                    }
                });
            });

            // STOP BUTTON (Initial placeholder, replaced dynamically)
            $("#btn-stop-scan").click(function () {
                // Fallback if clicked before scan starts? Should remain hidden.
            });

            // Global Cache - REMOVED (Using currentNetworkMap from oneditprepare)

            // --- Dropdown Logic ---

            // Helper: Transform technical name to human-readable label
            function formatLabel(str) {
                if (!str) return '';
                return str.split('_')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                    .join(' ');
            }

            let globalModelDefinitions = null;
            $.getJSON('sunspec-scan/models', function (allModels) {
                globalModelDefinitions = allModels;
                // If we were waiting to populate, maybe re-trigger? 
                // Mostly this loads fast enough before user clicks.
            });

            function populateModelsDropdown(models, currentMod) {
                const $mod = $("#node-input-selectedModel");
                $mod.empty().append('<option value="">-- Select Model --</option>');

                // Logic to run population once data available
                const runPopulate = (allModels) => {
                    const sortedMids = Object.keys(models).sort((a, b) => {
                        const na = parseInt(a);
                        const nb = parseInt(b);
                        if (isNaN(na) && isNaN(nb)) return a.localeCompare(b);
                        if (isNaN(na)) return 1; // Strings at end
                        if (isNaN(nb)) return -1;
                        return na - nb;
                    });
                    sortedMids.forEach(mid => {
                        if (mid === 'info') return;
                        const mDef = allModels[mid];
                        let mName = `Model ${mid}`;
                        if (mDef && mDef.group) {
                            mName = mDef.group.label || mDef.group.name || `Model ${mid}`;
                        }
                        $mod.append($('<option>', { value: mid, text: `${mid} - ${mName}` }));
                    });

                    // Restore Selection
                    let restored = false;
                    if (currentMod && $mod.find(`option[value='${currentMod}']`).length > 0) {
                        $mod.val(currentMod);
                        restored = true;
                    } else if (node.selectedModel && $mod.find(`option[value='${node.selectedModel}']`).length > 0) {
                        $mod.val(node.selectedModel);
                        restored = true;
                    }

                    if (restored) $mod.trigger('change');
                };

                if (globalModelDefinitions) {
                    runPopulate(globalModelDefinitions);
                } else {
                    // Fallback fetch if not ready (rare but possible on refresh)
                    $.getJSON('sunspec-scan/models', function (allModels) {
                        globalModelDefinitions = allModels;
                        runPopulate(allModels);
                    });
                }
            }

            function populateDeviceSelect(scanResults) {
                const $dev = $("#node-input-selectedDevice");
                const currentVal = $dev.val();
                $dev.empty().append('<option value="">-- Select Device --</option>');

                // Update Local Map from Scan Results
                if (scanResults) {
                    for (const ip in scanResults) {
                        currentNetworkMap[ip] = scanResults[ip];
                    }
                }

                // 1. Saved Devices Group
                if (savedDevices.length > 0) {
                    const group = $('<optgroup label="Saved Devices">');
                    savedDevices.forEach(d => {
                        const val = `${d.ip}:${d.unitId}`;
                        // Use saved name or format
                        group.append($('<option>', { value: val, text: d.name, 'data-port': d.port }));
                    });
                    $dev.append(group);
                }

                // 2. Network/Discovered Devices
                const netGroup = $('<optgroup label="Network Scan">');
                let hasNet = false;

                Object.keys(currentNetworkMap).forEach(function (ip) {
                    const idMap = currentNetworkMap[ip];
                    if (!idMap) return;

                    Object.keys(idMap).forEach(function (id) {
                        // Check if already in saved (by IP/ID)
                        const isSaved = savedDevices.some(s => s.ip === ip && s.unitId == id);
                        // Optional: Hide from network list if saved? Or show both?
                        // Showing both is confusing. Let's filter.
                        if (isSaved) return;

                        const models = idMap[id];
                        let label = "";
                        let combinedModel = "";

                        if (models && models.info) {
                            const mn = models.info.Mn || "";
                            const md = models.info.Md || "";
                            if (mn || md) label = `${mn} ${md}`;
                        }

                        // Fallback Label logic...
                        if (!label) label = `Unknown Device`;

                        // Models list
                        if (models) {
                            const mList = Object.keys(models).filter(m => m !== 'info').join(', ');
                            if (mList) combinedModel = `(Models: ${mList})`;
                        }

                        const text = `${ip}:${id} - ${label} ${combinedModel}`;
                        netGroup.append($('<option>', { value: `${ip}:${id}`, text: text }));
                        hasNet = true;
                    });
                });

                if (hasNet) $dev.append(netGroup);

                // If currently selected is NOT in list (ghost), add it
                if (node.selectedDevice) {
                    const exists = $dev.find(`option[value='${node.selectedDevice}']`).length > 0;
                    if (!exists) {
                        const ghostLabel = node.selectedDeviceLabel || node.selectedDevice;
                        $dev.append($('<option>', { value: node.selectedDevice, text: ghostLabel, selected: true }));
                    }
                }

                if (currentVal) {
                    $dev.val(currentVal).trigger('change');
                } else if (node.selectedDevice) {
                    $dev.val(node.selectedDevice).trigger('change');
                }
            }



            // Initial Populate on Open (Call ONCE)
            populateDeviceSelect(null);

            // Devices -> Models (LAZY LOADING)
            $("#node-input-selectedDevice").change(function () {
                const dev = $(this).val();

                // Save Label
                const label = $(this).find("option:selected").text();
                if (dev) node.selectedDeviceLabel = label;

                const $mod = $("#node-input-selectedModel");
                const currentMod = $mod.val();
                $mod.empty().append('<option value="">-- Select Model --</option>');

                // Also Reset Point Dropdown
                $("#node-input-selectedPoint").empty().append('<option value="">-- Select Point --</option>');

                if (dev) {
                    const [ip, id] = dev.split(':');
                    $("#node-input-selectedId").val(id);

                    const cache = currentNetworkMap;

                    // CHECK IF MODELS LOADED
                    const deviceData = (cache[ip] && cache[ip][id]) ? cache[ip][id] : null;

                    if (!deviceData || Object.keys(deviceData).length <= 2) {
                        // LAZY LOAD TRIGGER
                        $mod.append('<option value="" disabled>Loading models (deep scanning)...</option>');
                        const port = $("#node-input-port").val();
                        const timeout = $("#node-input-timeout").val();

                        $.ajax({
                            url: "sunspec-scan/scan-models",
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify({
                                ip: ip,
                                port: port,
                                unitId: id,
                                timeout: timeout
                            }),
                            success: function (fullModels) {
                                // MERGE into cache
                                if (!cache[ip]) cache[ip] = {};
                                cache[ip][id] = fullModels;
                                populateModelsDropdown(fullModels, currentMod);
                            },
                            error: function () {
                                RED.notify("Failed to load models for device", "error");
                                $mod.empty().append('<option value="">Error loading models</option>');
                            }
                        });

                    } else if (deviceData) {
                        // Already cached
                        populateModelsDropdown(deviceData, currentMod);
                    } else {
                        // Ghost Device
                        if (node.selectedModel) {
                            const ghostLabel = node.selectedModelLabel || node.selectedModel;
                            $mod.append($('<option>', { value: node.selectedModel, text: ghostLabel, selected: true }));
                        }
                    }
                }
            });

            // Models -> Points
            $("#node-input-selectedModel").change(function () {
                const mid = $(this).val();
                if (mid) node.selectedModelLabel = $(this).find("option:selected").text();

                const $pt = $("#node-input-selectedPoint");
                const currentPt = $pt.val();
                $pt.empty().append('<option value="">-- Select Point --</option>');

                if (!mid) return;

                // Abort previous request if pending
                if (node.currentModelRequest) {
                    node.currentModelRequest.abort();
                }

                // Show loading state
                $pt.append('<option value="" disabled>Loading points...</option>');
                $pt.prop('disabled', true);

                // Get implemented points from scan cache
                const deviceKey = $("#node-input-selectedDevice").val();
                let implementedPoints = null;

                if (deviceKey) {
                    const [ip, id] = deviceKey.split(':');
                    // Check nested cache structure [IP][ID][ModelID]
                    if (currentNetworkMap &&
                        currentNetworkMap[ip] &&
                        currentNetworkMap[ip][id] &&
                        currentNetworkMap[ip][id][mid]) {

                        implementedPoints = currentNetworkMap[ip][id][mid].implementedPoints;
                        console.log(`[SunSpec UI] Model ${mid}: Loaded ${implementedPoints ? implementedPoints.length : 'null'} implemented points from cache.`);
                    } else {
                        console.log(`[SunSpec UI] Model ${mid}: No scan cache found at ${ip}[${id}][${mid}]`);
                    }
                }

                node.currentModelRequest = $.getJSON('sunspec-scan/models', function (allModels) {
                    node.currentModelRequest = null;
                    // Clear loading state
                    $pt.empty().append('<option value="">-- Select Point --</option>');
                    $pt.prop('disabled', false);

                    const mDef = allModels[mid];
                    if (mDef) {
                        // Sort Points Alphabetically
                        const sortedPoints = mDef.group.points.sort((a, b) => (a.label || a.name).localeCompare(b.label || b.name));
                        let filteredCount = 0;
                        let totalCount = 0;

                        sortedPoints.forEach(p => {
                            // Filter out Scale Factors and Pads
                            if (p.type === 'sunssf' || p.type === 'pad') return;

                            totalCount++;

                            // Filter out unimplemented points if we have scan data
                            if (implementedPoints && !implementedPoints.includes(p.name)) {
                                filteredCount++;
                                return;
                            }

                            // Priority: desc > label > name
                            const rawLabel = p.desc || p.label || p.name;
                            // Only format if it looks like a crude identifier (no spaces, snake_case)
                            // and doesn't look like a good sentence.
                            let label = rawLabel;
                            if (!p.desc && !p.label) {
                                label = formatLabel(rawLabel);
                            }
                            $pt.append($('<option>', { value: p.name, text: label }));
                        });

                        // Add feedback message if filtering occurred
                        if (implementedPoints && filteredCount > 0) {
                            $pt.prepend(`<option value="" disabled>✓ Filtered ${filteredCount} unimplemented point${filteredCount > 1 ? 's' : ''}</option>`);
                        }
                    }

                    // Restore
                    // Restore only if we are on the configured model
                    if (mid == node.selectedModel) {
                        if (currentPt && $pt.find(`option[value='${currentPt}']`).length > 0) $pt.val(currentPt);
                        else if (node.selectedPoint && $pt.find(`option[value='${node.selectedPoint}']`).length > 0) $pt.val(node.selectedPoint);
                        else if (node.selectedPoint) {
                            const ghostLabel = node.selectedPointLabel || node.selectedPoint;
                            $pt.append($('<option>', { value: node.selectedPoint, text: ghostLabel, selected: true }));
                        }
                    }
                }).fail(function () {
                    // Error handler - always re-enable dropdown
                    $pt.empty().append('<option value="">-- Select Point --</option>');
                    $pt.append('<option value="" disabled>⚠ Error loading points</option>');
                    $pt.prop('disabled', false);
                });
            });

            // Point Change -> Save Label
            $("#node-input-selectedPoint").change(function () {
                if ($(this).val()) node.selectedPointLabel = $(this).find("option:selected").text();
            });

            // --- Editable List (Custom List Mode) ---

            $("#node-input-outputList-container").editableList({
                addItem: function (container, i, item) {
                    const row = $('<div/>').appendTo(container);
                    $('<span/>', { style: "font-weight:bold; margin-right:10px;" }).text(item.label || "Item " + (i + 1)).appendTo(row);
                    $('<span/>', { style: "font-size:0.8em; color:#666;" }).text(`${item.device} [${item.model}/${item.point}]`).appendTo(row);

                    // Hidden inputs for persist
                    $('<input/>', { type: "hidden", class: "node-input-list-device", value: item.device }).appendTo(row);
                    $('<input/>', { type: "hidden", class: "node-input-list-id", value: item.id }).appendTo(row);
                    $('<input/>', { type: "hidden", class: "node-input-list-model", value: item.model }).appendTo(row);
                    $('<input/>', { type: "hidden", class: "node-input-list-point", value: item.point }).appendTo(row);
                },
                removable: true,
                sortable: true
            });

            // Populate List
            if (node.outputList) {
                for (var i = 0; i < node.outputList.length; i++) {
                    $("#node-input-outputList-container").editableList('addItem', node.outputList[i]);
                }
            }

            // "Add to List" Button Handler
            $("#btn-add-to-list").click(function () {
                const dev = $("#node-input-selectedDevice").val();
                const mod = $("#node-input-selectedModel").val();
                const pt = $("#node-input-selectedPoint").val();

                const devText = $("#node-input-selectedDevice option:selected").text();
                const modText = $("#node-input-selectedModel option:selected").text();
                const ptText = $("#node-input-selectedPoint option:selected").text();

                if (!dev || !mod || !pt) {
                    RED.notify("Please select Device, Model, and Point first.", "warning");
                    return;
                }

                const [ip, defaultId] = dev.split(':');
                const overrideId = $("#node-input-selectedId").val();
                const id = overrideId || defaultId;

                const item = {
                    device: ip,
                    id: id,
                    model: mod,
                    point: pt,
                    label: `${modText} - ${ptText}`
                };

                $("#node-input-outputList-container").editableList('addItem', item);
                RED.notify("Added to list", "success");
            });
            // Update Port on Device Selection if Saved Device
            $("#node-input-selectedDevice").change(function () {
                const val = $(this).val();
                if (!val) return;
                const opt = $(this).find("option:selected");
                const savedPort = opt.data('port');
                if (savedPort) {
                    $("#node-input-port").val(savedPort);
                }
            });

            // MANAGE DEVICES LOGIC
            function refreshManageList() {
                const $list = $("#saved-device-list");
                $list.empty();
                if (savedDevices.length === 0) {
                    $list.append('<li style="color:#999; text-align:center; padding:20px;">No saved devices</li>');
                } else {
                    savedDevices.forEach(d => {
                        const li = $('<li>').css({ padding: '8px', borderBottom: '1px solid #eee', display: 'flex', justifyContent: 'space-between', alignItems: 'center' });
                        const info = $('<div>').html(`<b>${d.name}</b><br><small>${d.ip}:${d.port} ID:${d.unitId}</small>`);
                        const btns = $('<div>');
                        // Edit Btn
                        $('<button>').addClass('red-ui-button red-ui-button-small').html('<i class="fa fa-pencil"></i>')
                            .click(() => {
                                $("#manage-device-name").val(d.name);
                                $("#manage-device-ip").val(d.ip);
                                $("#manage-device-port").val(d.port);
                                $("#manage-device-unitId").val(d.unitId);
                                $("#btn-save-device").data('id', d.id).html('<i class="fa fa-save"></i> Update');
                            }).appendTo(btns);
                        // Delete Btn
                        $('<button>').addClass('red-ui-button red-ui-button-small').css({ marginLeft: '5px', color: '#a00' }).html('<i class="fa fa-trash"></i>')
                            .click(() => {
                                if (confirm("Delete this device?")) {
                                    $.ajax({
                                        url: 'sunspec-scan/devices/' + d.id,
                                        type: 'DELETE',
                                        success: () => {
                                            // Refresh
                                            $.getJSON('sunspec-scan/devices', function (devs) {
                                                savedDevices = devs || [];
                                                refreshManageList();
                                                populateDeviceSelect();
                                            });
                                        }
                                    });
                                }
                            }).appendTo(btns);

                        li.append(info).append(btns);
                        $list.append(li);
                    });
                }
            }

            $("#btn-manage-devices").click(function (e) {
                e.preventDefault();
                $("#dialog-manage-devices").dialog("open");
                refreshManageList();
            });

            $("#dialog-manage-devices").dialog({
                autoOpen: false,
                modal: true,
                width: 500,
                close: function () {
                    // Populate select on close to reflect changes
                    populateDeviceSelect();
                }
            });

            $("#btn-clear-manage-form").click(function () {
                $("#manage-device-name").val('');
                $("#manage-device-ip").val('');
                $("#manage-device-port").val('502');
                $("#manage-device-unitId").val('1');
                $("#btn-save-device").removeData('id').html('<i class="fa fa-save"></i> Save Device');
            });

            $("#btn-save-device").click(function () {
                const name = $("#manage-device-name").val();
                const ip = $("#manage-device-ip").val();
                const port = $("#manage-device-port").val();
                const unitId = $("#manage-device-unitId").val();
                const id = $(this).data('id');

                if (!ip) { RED.notify("IP Address required", "error"); return; }

                const payload = { name, ip, port, unitId };
                const method = id ? 'PUT' : 'POST';
                const url = 'sunspec-scan/devices' + (id ? '/' + id : '');

                $.ajax({
                    url: url,
                    type: method,
                    contentType: "application/json",
                    data: JSON.stringify(payload),
                    success: function () {
                        RED.notify("Device Saved", "success");
                        $("#btn-clear-manage-form").click();
                        // Refresh List
                        $.getJSON('sunspec-scan/devices', function (devs) {
                            savedDevices = devs || [];
                            refreshManageList();
                        });
                    },
                    error: function (xhr) {
                        RED.notify("Error: " + xhr.responseText, "error");
                    }
                });
            });
        },
        oneditsave: function () {
            const listItems = $("#node-input-outputList-container").editableList('items');
            const node = this;
            node.outputList = [];
            listItems.each(function (i) {
                const item = $(this);
                node.outputList.push({
                    device: item.find(".node-input-list-device").val(),
                    id: item.find(".node-input-list-id").val(),
                    model: item.find(".node-input-list-model").val(),
                    point: item.find(".node-input-list-point").val()
                });
            });
        }
    });
</script>

<script type="text/html" data-template-name="sunspec-scan">
    <!-- TABS -->
<div class="form-row">
    <ul style="background: #fff; min-width: 600px; margin-bottom: 20px;" id="node-input-sunspec-tabs"></ul>
</div>

<div id="node-input-tabs-content" style="min-height: 170px;">

    <!-- TAB: SCANNER (Main) -->
    <div id="sunspec-tab-scanner" style="display:none">
        <div class="form-row">
            <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
            <input type="text" id="node-input-name" placeholder="Name">
        </div>

        <div class="form-row">
            <label for="node-input-readMode"><i class="fa fa-cogs"></i> Mode</label>
            <select id="node-input-readMode">
                <option value="scan">Full Scan (All Models)</option>
                <option value="parameter">Read Single Parameter</option>
                <option value="list">Read Custom List (Array)</option>
            </select>
        </div>

        <!-- SCAN CONTROLS -->
        <div class="form-row">
            <label for="node-input-ip"><i class="fa fa-globe"></i> IP Address</label>
            <input type="text" id="node-input-ip" placeholder="0.0.0.0 (Empty = Scan Local)">
        </div>
        <div class="form-row">
            <label for="node-input-unitId"><i class="fa fa-bookmark"></i> Unit ID</label>
            <input type="text" id="node-input-unitId" placeholder="1, 126 or 1-10 (Empty = All)">
        </div>
        <div class="form-tips">
            <strong>Unit ID Scan Logic:</strong>
            <ul>
                <li><strong>Empty:</strong> Scan 1-247</li>
                <li><strong>Single:</strong> <code>126</code></li>
                <li><strong>List:</strong> <code>1, 50, 126</code></li>
                <li><strong>Range:</strong> <code>1-10</code></li>
            </ul>
        </div>
        <div class="form-row">
            <label for="node-input-pacing"><i class="fa fa-refresh"></i> Auto-Read (s)</label>
            <input type="text" id="node-input-pacing" placeholder="0 or empty to disable">
        </div>

        <!-- DISCOVERY BUTTON -->
        <div class="form-row">
            <label>&nbsp;</label>
            <div style="display:inline-block;">
                <button id="btn-scan-network" class="red-ui-button"><i class="fa fa-search"></i> Scan Network</button>
                <button id="btn-stop-scan" class="red-ui-button"
                    style="margin-left:10px; background-color:#ad1625; color:white; display:none;"><i
                        class="fa fa-stop"></i> Stop</button>
            </div>
        </div>
        <!-- Progress Bar -->
        <div class="form-row" id="scan-progress-bar" style="display:none;">
            <label>&nbsp;</label>
            <div style="display:inline-block; width:70%;">
                <div style="width:100%; background-color:#ddd; height:20px; border-radius:3px; overflow:hidden;">
                    <div
                        style="width:100%; height:100%; background-color:#5bc0de; animation: progress-indeterminate 2s infinite linear; transform-origin: 0% 50%;">
                    </div>
                </div>
                <div id="scan-status-text" style="font-size:0.8em; color:#666; text-align:center; margin-top:2px;">
                    Initializing scan...</div>
            </div>
        </div>

        <hr>

        <!-- PARAMETER SELECTION -->
        <fieldset class="param-mode-only list-mode-only mode-group">
            <legend>Parameter Selection</legend>
            <div class="form-tips">Use "Scan Network" above to populate, then select params.</div>
            <br>
            <div class="form-row">
                <label for="node-input-selectedDevice"><i class="fa fa-server"></i> Device</label>
                <div style="display:inline-block; width:70%;">
                    <select id="node-input-selectedDevice" style="width:calc(100% - 40px);">
                        <option value="">(Scan to populate)</option>
                    </select>
                    <button id="btn-manage-devices" class="red-ui-button" title="Manage Saved Devices"
                        style="width:35px; margin-left:5px;"><i class="fa fa-cog"></i></button>
                </div>
            </div>
            <!-- Explicit ID Field for Single Parameter Mode -->
            <!-- Hidden ID Field for Single Parameter Mode (Auto-populated) -->
            <input type="hidden" id="node-input-selectedId">

            <div class="form-row">
                <label for="node-input-selectedModel"><i class="fa fa-cube"></i> Model</label>
                <select id="node-input-selectedModel" style="width:70%;">
                    <option value="">-- Select Model --</option>
                </select>
            </div>
            <div class="form-row">
                <label for="node-input-selectedPoint"><i class="fa fa-crosshairs"></i> Point</label>
                <select id="node-input-selectedPoint" style="width:70%;">
                    <option value="">-- Select Point --</option>
                </select>
            </div>
            <div class="form-row">
                <label for="node-input-roundDecimals"><i class="fa fa-calculator"></i> Round Output</label>
                <input type="checkbox" id="node-input-roundDecimals" style="width:auto; margin-left:0;">
                <label for="node-input-roundDecimals" style="width:auto; margin-left:8px;">Round to 2 decimal
                    places</label>
            </div>

            <!-- ADD BUTTON (List Mode Only) -->
            <div class="form-row list-mode-only mode-group">
                <label>&nbsp;</label>
                <button id="btn-add-to-list" class="red-ui-button"><i class="fa fa-plus"></i> Add to List</button>
            </div>
        </fieldset>

        <!-- OUTPUT LIST (List Mode Only) -->
        <fieldset class="list-mode-only mode-group">
            <legend>Output List</legend>
            <div class="form-tips">Items will be output as an array in this order.</div>
            <div class="form-row node-input-outputList-container-row">
                <ol id="node-input-outputList-container"></ol>
            </div>
        </fieldset>
    </div>

    <!-- TAB: SETTINGS (Advanced) -->
    <div id="sunspec-tab-settings" style="display:none">
        <div class="form-row">
            <label for="node-input-port"><i class="fa fa-random"></i> Port</label>
            <input type="number" id="node-input-port" placeholder="502">
        </div>
        <div class="form-row">
            <label for="node-input-timeout"><i class="fa fa-clock-o"></i> Timeout (ms)</label>
            <input type="number" id="node-input-timeout" placeholder="2000">
        </div>

        <!-- Removed Scan All Checkbox - Logic is now inferred from Unit ID field -->
        <div class="form-tips">
            <strong>Unit ID Logic:</strong>
            <ul>
                <li><strong>Empty:</strong> Scans all IDs (1-247).</li>
                <li><strong>Single:</strong> <code>126</code></li>
                <li><strong>List:</strong> <code>1, 126</code></li>
                <li><strong>Range:</strong> <code>1-10</code></li>
            </ul>
        </div>
    </div>
</div>

<!-- DEVICE MANAGEMENT MODAL -->
<div id="dialog-manage-devices" style="display:none">
    <div class="form-row">
        <label for="manage-device-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="manage-device-name" placeholder="My Device">
    </div>
    <div class="form-row">
        <label for="manage-device-ip"><i class="fa fa-globe"></i> IP</label>
        <input type="text" id="manage-device-ip" placeholder="192.168.1.10">
    </div>
    <div class="form-row">
        <label for="manage-device-port"><i class="fa fa-random"></i> Port</label>
        <input type="number" id="manage-device-port" placeholder="502" style="width:80px">
        <label for="manage-device-unitId" style="width:auto; margin-left:10px;">ID</label>
        <input type="number" id="manage-device-unitId" placeholder="1" style="width:60px">
    </div>
    <div class="form-row" style="text-align:right;">
        <button id="btn-save-device" class="red-ui-button"><i class="fa fa-save"></i> Save Device</button>
        <button id="btn-clear-manage-form" class="red-ui-button" style="margin-left:5px;">New</button>
    </div>
    <hr>
    <div class="form-row">
        <label style="width:100%;"><i class="fa fa-list"></i> Saved Devices</label>
    </div>
    <div class="form-row" style="height:200px; overflow-y:auto; border:1px solid #ccc; background:#fff; padding:5px;">
        <ul id="saved-device-list" style="list-style:none; padding:0; margin:0;">
            <!-- Items injected here -->
            <li style="color:#999; text-align:center; padding:20px;">No saved devices</li>
        </ul>
    </div>
</div>
</script>

<script type="text/html" data-help-name="sunspec-scan">
    <p>Scans a SunSpec device via Modbus TCP and outputs identified models.</p>
    
    <h3>Modes</h3>
    <dl>
        <dt>Full Scan</dt>
        <dd>Scans the provided IP/Range and outputs ONLY model data found on the network.</dd>
        
        <dt>Read Single Parameter</dt>
        <dd>Read a single SCALED value. Use the "Unit ID" field to target a specific slave ID if needed.</dd>
        
        <dt>Read Custom List</dt>
        <dd>Read multiple parameters and output them as a fixed-order array.</dd>
    </dl>
</script>